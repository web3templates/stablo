"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Document;

var _react = _interopRequireWildcard(require("react"));

var _generateScriptLoader = _interopRequireDefault(require("../util/generateScriptLoader"));

var _uncaughtErrorHandler = _interopRequireDefault(require("../util/uncaughtErrorHandler"));

var _AppLoadingScreen = _interopRequireDefault(require("./AppLoadingScreen"));

var _NoJavascript = _interopRequireDefault(require("./NoJavascript"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

var DEFAULT_FAVICONS = [{
  path: 'favicon.ico'
}];

function Document(props) {
  var _props$basePath = props.basePath,
      basePathProp = _props$basePath === void 0 ? '' : _props$basePath,
      _props$charset = props.charset,
      charset = _props$charset === void 0 ? 'utf-8' : _props$charset,
      _props$title = props.title,
      title = _props$title === void 0 ? 'Sanity' : _props$title,
      _props$viewport = props.viewport,
      viewport = _props$viewport === void 0 ? 'width=device-width, initial-scale=1, viewport-fit=cover' : _props$viewport,
      _props$loading = props.loading,
      loading = _props$loading === void 0 ? 'Connecting to Sanity.io' : _props$loading,
      _props$staticPath = props.staticPath,
      staticPathProp = _props$staticPath === void 0 ? '/static' : _props$staticPath,
      _props$favicons = props.favicons,
      faviconsProp = _props$favicons === void 0 ? DEFAULT_FAVICONS : _props$favicons,
      _props$stylesheets = props.stylesheets,
      stylesheetsProp = _props$stylesheets === void 0 ? [] : _props$stylesheets,
      _props$scripts = props.scripts,
      scriptsProp = _props$scripts === void 0 ? [] : _props$scripts;
  var basePath = basePathProp.replace(/\/+$/, '');
  var staticPath = "".concat(basePath).concat(staticPathProp);
  var stylesheets = (0, _react.useMemo)(() => stylesheetsProp.map(item => /*#__PURE__*/_react.default.createElement("link", {
    key: item.path,
    rel: "stylesheet",
    href: assetUrl(staticPath, item)
  })), [stylesheetsProp, staticPath]);
  var subresources = (0, _react.useMemo)(() => scriptsProp.map(item => /*#__PURE__*/_react.default.createElement("link", {
    key: item.path,
    rel: "subresource",
    href: assetUrl(staticPath, item)
  })), [scriptsProp, staticPath]);
  var scripts = (0, _react.useMemo)(() => scriptsProp.map(item => assetUrl(staticPath, item)), [scriptsProp, staticPath]);
  var scriptLoader = (0, _react.useMemo)(() => (0, _generateScriptLoader.default)(scripts), [scripts]);
  var errorHandler = (0, _react.useMemo)(() => (0, _uncaughtErrorHandler.default)(), []);
  var favicons = (0, _react.useMemo)(() => faviconsProp.map(item => /*#__PURE__*/_react.default.createElement("link", {
    key: item.path,
    rel: "icon",
    href: assetUrl(staticPath, item)
  })), [faviconsProp, staticPath]);
  return /*#__PURE__*/_react.default.createElement("html", null, /*#__PURE__*/_react.default.createElement("head", null, /*#__PURE__*/_react.default.createElement("meta", {
    charSet: charset
  }), /*#__PURE__*/_react.default.createElement("title", null, title), /*#__PURE__*/_react.default.createElement("meta", {
    name: "viewport",
    content: viewport
  }), /*#__PURE__*/_react.default.createElement("meta", {
    name: "robots",
    content: "noindex"
  }), /*#__PURE__*/_react.default.createElement("style", null, "html {background-color: #f1f3f6;}"), stylesheets, subresources, favicons), /*#__PURE__*/_react.default.createElement("body", {
    id: "sanityBody"
  }, /*#__PURE__*/_react.default.createElement("div", {
    id: "sanity"
  }, /*#__PURE__*/_react.default.createElement(_AppLoadingScreen.default, {
    text: loading
  }), /*#__PURE__*/_react.default.createElement(_NoJavascript.default, null)), /*#__PURE__*/_react.default.createElement("script", {
    dangerouslySetInnerHTML: {
      __html: errorHandler
    }
  }), /*#__PURE__*/_react.default.createElement("script", {
    dangerouslySetInnerHTML: {
      __html: scriptLoader
    }
  })));
}

function assetUrl(staticPath, item) {
  var isAbsolute = item.path.match(/^https?:\/\//);

  if (isAbsolute) {
    return item.path;
  }

  var base = "".concat(staticPath, "/").concat(item.path);

  if (!item.hash) {
    return base;
  }

  var hasQuery = base.indexOf('?') !== -1;
  var separator = hasQuery ? '&' : '?';
  return "".concat(base).concat(separator).concat(item.hash);
}